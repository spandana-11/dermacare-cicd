import{R as be,u as ke,r as n,b as Ee,a as Te,j as e,Q as $e,B as C}from"./index-BpN0qZrt.js";import{b as M}from"./index.esm-BAveQmLP.js";import{C as Ae,d as Le,a as Ce,u as Pe,b as Re}from"./CustomerManagementAPI-DT1K1zJX.js";import{L as He}from"./loader-OBkaezw1.js";import{C as Ve}from"./ConfirmationModal-Blpddd1P.js";import{C as v,a as i}from"./CRow-D0GPXItY.js";import{C as Ye,a as qe,b as _,c as O,d as Ge,e as S}from"./CTable-Bgk4qBUR.js";import{E as ze}from"./eye-BuIXT__x.js";import{P as Qe,T as Ue}from"./trash-2-CRkTwtCJ.js";import{C as Ke,a as We,b as Ze}from"./CModalHeader-DLH-68_W.js";import{C as _e}from"./CModalTitle-CwvqIfsB.js";import{C as Je}from"./CModalFooter-Dm04Litg.js";import{C as Xe}from"./CForm-D_Fm9Pc8.js";import{C as c}from"./CFormLabel-DO0eStXP.js";import{C as Ne}from"./CFormSelect-DDJD4c8G.js";import{C as u}from"./CFormInput-DMF4wKOV.js";import"./CNavItem-DIVzBTzM.js";const et=()=>{var oe,de,ce,me,he,ue,fe,xe,ge;ke();const[F,A]=n.useState([]),[L,N]=n.useState(!1),[J,X]=n.useState(null),[D,ye]=n.useState(1),[k,tt]=n.useState(10),[st,ee]=n.useState(null),[at,P]=n.useState(""),[ve,R]=n.useState(!1),[te,H]=n.useState(null),[o,se]=n.useState({}),{searchQuery:V,setSearchQuery:rt}=Ee(),[Se,Y]=n.useState(!1),[j,ae]=n.useState(!1),[De,q]=n.useState(!1),[m,re]=n.useState(null),[r,p]=n.useState({customerId:"",title:"",firstName:"",lastName:"",fullName:"",mobileNumber:"",gender:"",email:"",dateOfBirth:"",referralCode:"",age:"",hospitalId:localStorage.getItem("HospitalId")||"",hospitalName:localStorage.getItem("HospitalName")||"",branchId:localStorage.getItem("branchId")||"",address:{houseNo:"",street:"",landmark:"",city:"",state:"",country:"India",postalCode:""}}),[lt,nt]=n.useState([]),[it,ot]=n.useState(!1),I=n.useRef(null);n.useEffect(()=>()=>{},[]);const x=(t,s,a)=>{p(l=>({...l,[t]:{...l[t],[s]:a}}))},{user:G}=Te(),E=(t,s)=>{var a,l;return(l=(a=G==null?void 0:G.permissions)==null?void 0:a[t])==null?void 0:l.includes(s)},le=t=>{/^\d*$/.test(t)&&(x("address","postalCode",t),I.current&&clearTimeout(I.current),t.length===6&&(I.current=setTimeout(async()=>{var s;try{const a=await fetch(`https://api.postalpincode.in/pincode/${t}`);if(!a.ok)throw new Error(`pincode API ${a.status}`);const l=await a.json();if(((s=l==null?void 0:l[0])==null?void 0:s.Status)==="Success"&&Array.isArray(l[0].PostOffice)&&l[0].PostOffice.length){const h=l[0].PostOffice[0];x("address","street",h.Name||""),x("address","city",h.Region||""),x("address","landmark",h.Block||""),x("address","state",h.State||"")}else console.warn("No PostOffice data returned for pincode",t,l)}catch(a){console.warn("Error fetching pincode data:",a)}},300)))};n.useEffect(()=>()=>{I.current&&clearTimeout(I.current)},[]);const z=n.useCallback(async()=>{N(!0),X(null);try{const t=await Ae(),s=Array.isArray(t)?t.filter(a=>a&&typeof a=="object"):[];A(s)}catch(t){console.error("Error fetching customers:",t),X("Failed to fetch customer data."),A([])}finally{N(!1)}},[]);n.useEffect(()=>{z()},[z]);const w=t=>t?t.toLowerCase().replace(/\b\w/g,s=>s.toUpperCase()):"",Ie=async t=>{try{N(!0);const s=await Ce(t),a=Array.isArray(s)?s[0]:s;re(a),q(!0)}catch(s){console.error("Failed to fetch customer:",s),C.error("Failed to load customer data")}finally{N(!1)}},we=async t=>{var s,a,l,h,b,T,je;try{N(!0);const B=await Ce(t),d=Array.isArray(B)?B[0]:B;let U="";if(d.dateOfBirth){const f=d.dateOfBirth;if(/^\d{2}-\d{2}-\d{4}$/.test(f)){const[y,W,Z]=f.split("-");U=`${Z}-${W}-${y}`}else{const y=new Date(f);if(!isNaN(y)){const W=y.getFullYear(),Z=String(y.getMonth()+1).padStart(2,"0"),Fe=String(y.getDate()).padStart(2,"0");U=`${W}-${Z}-${Fe}`}}}let K="",$="",pe="";if(d.fullName){const f=d.fullName.trim().split(" ");f.length>=3?(K=f[0],$=f[1],pe=f.slice(2).join(" ")):f.length===2?(K=f[0],$=f[1]):f.length===1&&($=f[0])}p({customerId:d.customerId||"",title:K,firstName:$,lastName:pe,fullName:d.fullName||"",mobileNumber:d.mobileNumber||"",gender:d.gender||"",email:d.email||"",dateOfBirth:U,referralCode:d.referralCode||"",age:d.age||"",hospitalId:localStorage.getItem("HospitalId")||"",hospitalName:localStorage.getItem("HospitalName")||"",branchId:localStorage.getItem("branchId")||"",address:{houseNo:((s=d.address)==null?void 0:s.houseNo)||"",street:((a=d.address)==null?void 0:a.street)||"",landmark:((l=d.address)==null?void 0:l.landmark)||"",city:((h=d.address)==null?void 0:h.city)||"",state:((b=d.address)==null?void 0:b.state)||"",country:((T=d.address)==null?void 0:T.country)||"India",postalCode:((je=d.address)==null?void 0:je.postalCode)||""}}),Y(!0),ae(!0),ee(d.mobileNumber),re(d)}catch(B){console.error("Failed to fetch customer:",B),C.error("Failed to load customer data")}finally{N(!1)}},g=t=>{const{name:s,value:a}=t.target;p({...r,[s]:a});const l={...o};l[s]&&(delete l[s],se(l))};n.useEffect(()=>{j&&r.address.postalCode&&le(r.address.postalCode)},[j]);const Be=async t=>{var s;if(t.preventDefault(),console.log("Submitting form",r),!!Oe())try{const a={...r};if(a.fullName=`${r.title} ${r.firstName} ${r.lastName}`.trim(),a.dateOfBirth){const l=new Date(a.dateOfBirth);if(!isNaN(l)){const h=String(l.getDate()).padStart(2,"0"),b=String(l.getMonth()+1).padStart(2,"0"),T=l.getFullYear();a.dateOfBirth=`${h}-${b}-${T}`}}j?(await Pe(r.customerId,a),C.success("Customer updated successfully")):(await Re(a),C.success("Customer added successfully"),p({title:"",firstName:"",lastName:"",fullName:"",dateOfBirth:"",email:"",mobile:"",address:""})),await z(),ne()}catch(a){console.error("Error submitting customer:",a),((s=a==null?void 0:a.response)==null?void 0:s.status)===409&&C.error("Customer already exists with this mobile number or email.")}},ne=()=>{Y(!1),ae(!1),ee(null),j||setIsViewing(!1),p({customerId:"",title:"",firstName:"",lastName:"",fullName:"",mobileNumber:"",gender:"",email:"",dateOfBirth:"",referralCode:"",age:"",hospitalId:localStorage.getItem("HospitalId")||"",hospitalName:localStorage.getItem("HospitalName")||"",branchId:localStorage.getItem("branchId")||"",address:{houseNo:"",street:"",landmark:"",city:"",state:"",country:"India",postalCode:""}})},Q=be.useMemo(()=>{const t=V.toLowerCase().trim();return t?F.filter(s=>Object.values(s).some(a=>String(a).toLowerCase().includes(t))):F},[V,F]),ie=Q.slice((D-1)*k,D*k);n.useEffect(()=>{if(r.dateOfBirth){const t=new Date(r.dateOfBirth);if(isNaN(t))P("");else{const s=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),l=t.getFullYear();P(`${s}-${a}-${l}`)}}else P("")},[r.dateOfBirth]);const Me=async()=>{try{await Le(te),C.success("Customer deleted successfully");const t=F.filter(s=>(s==null?void 0:s.customerId)!==te);A(t)}catch(t){console.error("Delete failed:",t),C.error("Failed to delete customer")}finally{R(!1),H(null)}},Oe=()=>{const t={};if(r.title.trim()?/\d/.test(r.title)&&(t.title="Title should not contain numbers"):t.title="Title is required",r.firstName.trim()?/\d/.test(r.firstName)&&(t.firstName="First Name should not contain numbers"):t.firstName="First Name is required",r.mobileNumber.trim()?/^[1-9]\d{9}$/.test(r.mobileNumber)||(t.mobileNumber="Mobile number must be 10 digits (starting from 1-9)"):t.mobileNumber="Mobile number is required",r.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)||(t.email="Email must be valid and contain @"):t.email="Email is required",!r.dateOfBirth.trim())t.dateOfBirth="Date of Birth is required";else{const s=new Date(r.dateOfBirth),a=s.getFullYear(),l=new Date;if(isNaN(s))t.dateOfBirth="Invalid Date of Birth";else if(a.toString().length!==4)t.dateOfBirth="Year must be 4 digits";else if(s>l)t.dateOfBirth="Date of Birth cannot be in the future";else{const h=new Date;h.setFullYear(l.getFullYear()-120),s<h&&(t.dateOfBirth="Date of Birth must not be more than 120 years ago")}}return r.gender||(t.gender="Gender is required"),r.referralCode&&/[^a-zA-Z0-9]/.test(r.referralCode)&&(t.referralCode="Refer code must contain only letters and numbers"),se(t),Object.keys(t).length===0};return e.jsx(e.Fragment,{children:Se?e.jsxs(e.Fragment,{children:[e.jsx("h4",{className:"mb-4",children:j?"Edit Customer":"Add New Customer"}),e.jsxs(Xe,{onSubmit:Be,children:[e.jsxs(v,{className:"mb-3",children:[e.jsxs(i,{md:2,children:[e.jsxs(c,{children:["Title ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs(Ne,{name:"title",value:r.title,onChange:g,invalid:!!o.title,children:[e.jsx("option",{value:"",children:"Select Title"}),e.jsx("option",{value:"Mr.",children:"Mr."}),e.jsx("option",{value:"Mrs.",children:"Mrs."}),e.jsx("option",{value:"Miss",children:"Miss."}),e.jsx("option",{value:"Ms.",children:"Ms."}),e.jsx("option",{value:"Mx.",children:"Mx."}),e.jsx("option",{value:"Dr.",children:"Dr."}),e.jsx("option",{value:"Prof.",children:"Prof."}),e.jsx("option",{value:"Rev.",children:"Rev."}),e.jsx("option",{value:"Sir",children:"Sir."}),e.jsx("option",{value:"Dame",children:"Dame."}),e.jsx("option",{value:"Lord",children:"Lord"}),e.jsx("option",{value:"Lady",children:"Lady"}),e.jsx("option",{value:"Capt.",children:"Capt."}),e.jsx("option",{value:"Col.",children:"Col."}),e.jsx("option",{value:"Gen.",children:"Gen."}),e.jsx("option",{value:"Hon.",children:"Hon."})]}),o.title&&e.jsx("div",{className:"text-danger small",children:o.title})]}),e.jsxs(i,{md:4,children:[e.jsxs(c,{children:["First Name ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(u,{name:"firstName",value:r.firstName,onChange:g,invalid:!!o.firstName}),o.firstName&&e.jsx("div",{className:"text-danger small",children:o.firstName})]}),e.jsxs(i,{md:3,children:[e.jsx(c,{children:"Last Name"}),e.jsx(u,{name:"lastName",value:r.lastName,onChange:g})]}),e.jsxs(i,{md:3,children:[e.jsxs(c,{children:["Date of Birth ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(u,{type:"date",name:"dateOfBirth",value:r.dateOfBirth,onChange:t=>{g(t);const s=new Date(t.target.value);if(isNaN(s))p(a=>({...a,age:""}));else{const a=Date.now()-s.getTime(),l=new Date(a),h=Math.abs(l.getUTCFullYear()-1970);p(b=>({...b,age:h.toString()}))}},max:new Date().toISOString().split("T")[0],invalid:!!o.dateOfBirth}),o.dateOfBirth&&e.jsx("div",{className:"text-danger small",children:o.dateOfBirth})]})]}),e.jsxs(v,{className:"mb-3",children:[e.jsxs(i,{md:2,children:[e.jsx(c,{children:"Age"}),e.jsx(u,{name:"age",value:r.age||"",readOnly:!0})]}),e.jsxs(i,{md:4,children:[e.jsxs(c,{children:["Email ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(u,{type:"email",name:"email",value:r.email,onChange:g,invalid:!!o.email}),o.email&&e.jsx("div",{className:"text-danger small",children:o.email})]}),e.jsxs(i,{md:3,children:[e.jsxs(c,{children:["Mobile Number",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(u,{name:"mobileNumber",value:r.mobileNumber,onChange:g,onKeyDown:t=>{!/[0-9]/.test(t.key)&&t.key!=="Backspace"&&t.key!=="Delete"&&t.preventDefault()},onPaste:t=>t.preventDefault(),maxLength:10,invalid:!!o.mobileNumber,disabled:j}),o.mobileNumber&&e.jsx("div",{className:"text-danger small",children:o.mobileNumber})]}),e.jsxs(i,{md:3,children:[e.jsxs(c,{children:["Gender ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs(Ne,{name:"gender",value:r.gender,onChange:g,invalid:!!o.gender,children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"Male",children:"Male"}),e.jsx("option",{value:"Female",children:"Female"}),e.jsx("option",{value:"Others",children:"Others"})]}),o.gender&&e.jsx("div",{className:"text-danger small",children:o.gender})]})]}),e.jsxs(v,{className:"mt-3",children:[e.jsxs(i,{md:2,children:[e.jsxs(c,{children:["House No ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(u,{type:"text",value:((xe=r.address)==null?void 0:xe.houseNo)||"",onChange:t=>x("address","houseNo",t.target.value)})]}),e.jsxs(i,{md:4,children:[e.jsxs(c,{children:["Postal Code ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(u,{type:"text",maxLength:6,value:((ge=r.address)==null?void 0:ge.postalCode)||"",onChange:t=>le(t.target.value),placeholder:"6-digit PIN"})]}),e.jsxs(i,{md:3,children:[e.jsxs(c,{children:["Street ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(u,{type:"text",value:w(r.address.street),onChange:t=>x("address","street",t.target.value)})]}),e.jsxs(i,{md:3,children:[e.jsx(c,{children:"Landmark"}),e.jsx(u,{type:"text",value:w(r.address.landmark),onChange:t=>x("address","landmark",t.target.value)})]})]}),e.jsxs(v,{children:[e.jsxs(i,{md:2,children:[e.jsxs(c,{children:["City ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(u,{type:"text",value:w(r.address.city),onChange:t=>x("address","city",t.target.value)})]}),e.jsxs(i,{md:4,children:[e.jsxs(c,{children:["State ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(u,{type:"text",value:w(r.address.state),onChange:t=>x("address","state",t.target.value)})]}),e.jsxs(i,{md:3,children:[e.jsxs(c,{children:["Country ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(u,{type:"text",value:w(r.address.country),onChange:t=>x("address","country",t.target.value)})]}),e.jsxs(i,{md:3,children:[e.jsx(c,{children:"Referral Code"}),e.jsx(u,{name:"referralCode",value:r.referralCode,onChange:g}),o.referralCode&&e.jsx("div",{className:"text-danger",children:o.referralCode})]})]}),e.jsx("br",{}),e.jsxs("div",{className:"d-flex justify-content-end",children:[e.jsx(M,{color:"secondary",className:"me-2",onClick:ne,children:"Cancel"}),e.jsx(M,{type:"submit",color:"success",style:{backgroundColor:"var(--color-black)",color:"white",border:"none"},children:j?"Update":"Submit"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(v,{className:"d-flex align-items-center mb-3",children:[e.jsx($e,{}),E("Customer Management","create")&&e.jsx("div",{className:"mb-3 w-100",style:{display:"flex",justifyContent:"end",alignContent:"end",alignItems:"end"},children:e.jsx(M,{style:{color:"var(--color-black)",backgroundColor:"var(--color-bgcolor)"},onClick:()=>Y(!0),children:"Add New Customer"})})]}),e.jsx(Ve,{isVisible:ve,title:"Delete Customer",message:"Are you sure you want to delete this Customer? This action cannot be undone.",confirmText:"Yes, Delete",cancelText:"Cancel",confirmColor:"danger",cancelColor:"secondary",onConfirm:Me,onCancel:()=>{R(!1),H(null)}}),L?e.jsx("div",{className:"d-flex justify-content-center align-items-center",children:e.jsx(He,{message:"Loading customers..."})}):J?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"50vh",color:"var(--color-black)"},children:J}):Q.length===0?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"50vh",color:"var(--color-black)"},children:"No Customer Data Found"}):e.jsxs(e.Fragment,{children:[e.jsxs(Ye,{hover:!0,striped:!0,responsive:!0,children:[e.jsx(qe,{className:"pink-table  w-auto",children:e.jsxs(_,{children:[e.jsx(O,{children:"S.No"}),e.jsx(O,{children:"Full Name"}),e.jsx(O,{children:"Mobile Number"}),e.jsx(O,{children:"Gender"}),e.jsx(O,{className:"text-end",children:"Actions"})]})}),e.jsx(Ge,{className:"pink-table",children:ie.length>0?ie.map((t,s)=>e.jsxs(_,{children:[e.jsxs(S,{children:[" ",(D-1)*k+s+1]}),e.jsx(S,{children:(t==null?void 0:t.fullName)||"-"}),e.jsx(S,{children:(t==null?void 0:t.mobileNumber)||"-"}),e.jsx(S,{children:(t==null?void 0:t.gender)||"-"}),e.jsx(S,{className:"text-end",children:e.jsxs("div",{className:"d-flex justify-content-end gap-2  ",children:[E("Customer Management","read")&&e.jsx("button",{className:"actionBtn",onClick:()=>Ie(t==null?void 0:t.customerId),title:"View",children:e.jsx(ze,{size:18})}),E("Customer Management","update")&&e.jsx("button",{className:"actionBtn",onClick:()=>we(t==null?void 0:t.customerId),title:"Edit",children:e.jsx(Qe,{size:18})}),E("Customer Management","delete")&&e.jsx("button",{className:"actionBtn",onClick:()=>{H(t==null?void 0:t.customerId),R(!0)},title:"Delete",children:e.jsx(Ue,{size:18})})]})})]},t.mobileNumber||s)):e.jsx(_,{children:e.jsxs(S,{colSpan:5,className:"text-center text-muted",children:['ðŸ” No diseases found matching "',e.jsx("b",{children:V}),'"']})})})]}),e.jsxs(Ke,{visible:De,onClose:()=>q(!1),size:"lg",children:[e.jsx(We,{children:e.jsx(_e,{children:"Customer Details"})}),e.jsx(Ze,{children:L?e.jsx("div",{className:"text-center",children:"Loading..."}):m?e.jsxs(v,{className:"mb-2",children:[e.jsxs(i,{md:6,children:[e.jsx("strong",{children:"Full Name:"})," ",m.fullName||"-"]}),e.jsxs(i,{md:6,children:[e.jsx("strong",{children:"Mobile:"})," ",m.mobileNumber||"-"]}),e.jsxs(i,{md:6,children:[e.jsx("strong",{children:"Email:"})," ",m.email||"-"]}),e.jsxs(i,{md:6,children:[e.jsx("strong",{children:"Gender:"})," ",m.gender||"-"]}),e.jsxs(i,{md:6,children:[e.jsx("strong",{children:"DOB:"})," ",m.dateOfBirth||"-"]}),e.jsxs(i,{md:6,children:[e.jsx("strong",{children:"Age:"})," ",m.age||"-"]}),e.jsxs(i,{md:12,className:"mt-3",children:[e.jsx("h6",{children:"Address"}),e.jsxs("p",{children:[((oe=m.address)==null?void 0:oe.houseNo)||"",","," ",((de=m.address)==null?void 0:de.street)||"",","," ",((ce=m.address)==null?void 0:ce.landmark)||"",","," ",((me=m.address)==null?void 0:me.city)||"",","," ",((he=m.address)==null?void 0:he.state)||"",","," ",((ue=m.address)==null?void 0:ue.postalCode)||"",","," ",((fe=m.address)==null?void 0:fe.country)||""]})]})]}):e.jsx("p",{children:"No customer data available."})}),e.jsx(Je,{children:e.jsx(M,{color:"secondary",onClick:()=>q(!1),children:"Close"})})]}),!L&&e.jsx("div",{className:"d-flex justify-content-end mt-3",style:{marginRight:"40px"},children:Array.from({length:Math.ceil(Q.length/k)},(t,s)=>e.jsx(M,{style:{backgroundColor:D===s+1?"var(--color-black)":"#fff",color:D===s+1?"#fff":"var(--color-black)",border:"1px solid #ccc",borderRadius:"5px",cursor:"pointer"},className:"ms-2",onClick:()=>ye(s+1),children:s+1},s))})]})]})})},It=be.memo(et);export{It as default};
