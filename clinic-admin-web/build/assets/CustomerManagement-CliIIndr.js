import{R as K,h as le,r as l,n as oe,j as e,Q as ie,B as f}from"./index-DwsJnlHn.js";import{a as M}from"./index.esm-j8L8OUOY.js";import{C as de,d as ce,g as me,u as he,a as ue}from"./CustomerManagementAPI-BaGfbcwm.js";import{L as xe}from"./loader-Claeu4yt.js";import{C as fe}from"./ConfirmationModal-D9T4gQdx.js";import{C as y,a as i}from"./CRow-BvzboGfC.js";import{C as ge,a as je,b as A,c as v,d as pe,e as j}from"./CTable-D5A-WoAX.js";import{E as Ce}from"./eye-CwDnd1i1.js";import{P as be,T as Ne}from"./trash-2-xlXjzCT3.js";import{C as ye}from"./CForm-OJQsngod.js";import{C as d}from"./CFormLabel-BsqO6Mxs.js";import{C as q}from"./CFormSelect-BLkadGQI.js";import{C as c}from"./CFormInput-F3j-R7Zc.js";import"./CModalHeader-C9V0HcQQ.js";import"./CNavItem-D-_vrklN.js";import"./CModalTitle-JHBt9lNf.js";import"./CModalFooter-FSUtuZlu.js";import"./createLucideIcon-DHcmngCx.js";const ve=()=>{const W=le(),[S,B]=l.useState([]),[R,D]=l.useState(!1),[H,G]=l.useState(null),[p,_]=l.useState(1),[w,Se]=l.useState(10),[J,F]=l.useState(!1),[k,V]=l.useState(!1),[De,Y]=l.useState(null),[we,O]=l.useState(""),[X,I]=l.useState(!1),[z,T]=l.useState(null),[o,Z]=l.useState({}),{searchQuery:$,setSearchQuery:ke}=oe(),[n,g]=l.useState({title:"",firstName:"",lastName:"",fullName:"",mobileNumber:"",gender:"",emailId:"",dateOfBirth:"",referCode:"",age:"",hospitalId:localStorage.getItem("HospitalId"),hospitalName:localStorage.getItem("HospitalName"),branchId:localStorage.getItem("branchId"),address:{houseNo:"",street:"",landmark:"",city:"",state:"",country:"India",postalCode:""}}),[Me,Be]=l.useState([]),[Fe,Oe]=l.useState(!1),C=l.useRef(null);l.useEffect(()=>()=>{},[]);const h=(t,a,s)=>{g(r=>({...r,[t]:{...r[t],[a]:s}}))},ee=t=>{/^\d*$/.test(t)&&(h("address","postalCode",t),C.current&&clearTimeout(C.current),t.length===6&&(C.current=setTimeout(async()=>{var a;try{const s=await fetch(`https://api.postalpincode.in/pincode/${t}`);if(!s.ok)throw new Error(`pincode API ${s.status}`);const r=await s.json();if(((a=r==null?void 0:r[0])==null?void 0:a.Status)==="Success"&&Array.isArray(r[0].PostOffice)&&r[0].PostOffice.length){const m=r[0].PostOffice[0];h("address","street",m.Name||""),h("address","city",m.Region||""),h("address","landmark",m.Block||""),h("address","state",m.State||"")}else console.warn("No PostOffice data returned for pincode",t,r)}catch(s){console.warn("Error fetching pincode data:",s)}},300)))};l.useEffect(()=>()=>{C.current&&clearTimeout(C.current)},[]);const E=l.useCallback(async()=>{D(!0),G(null);try{const t=await de(),a=Array.isArray(t)?t.filter(s=>s&&typeof s=="object"):[];B(a)}catch(t){console.error("Error fetching customers:",t),G("Failed to fetch customer data."),B([])}finally{D(!1)}},[]);l.useEffect(()=>{E()},[E]);const b=t=>t?t.toLowerCase().replace(/\b\w/g,a=>a.toUpperCase()):"",te=t=>{W(`/customer-management/${t}`)},se=async t=>{try{D(!0);const a=await me(t),s=a.data||a;console.log("Customer data:",s);let r="";if(s.dateOfBirth){const m=s.dateOfBirth.trim();if(/^\d{2}-\d{2}-\d{4}$/.test(m)){const[u,N,L]=m.split("-");r=`${L}-${N}-${u}`}else{const u=new Date(m);if(!isNaN(u)){const N=u.getFullYear().toString().padStart(4,"0"),L=String(u.getMonth()+1).padStart(2,"0"),ne=String(u.getDate()).padStart(2,"0");r=`${N}-${L}-${ne}`}}}g({fullName:s.fullName||"",mobileNumber:s.mobileNumber||"",gender:s.gender||"",emailId:s.emailId||"",dateOfBirth:r,referCode:s.referCode||""}),Y(t),V(!0),F(!0)}catch(a){console.error("Failed to fetch customer:",a),f.error("Failed to load customer data")}finally{D(!1)}},x=t=>{const{name:a,value:s}=t.target;g({...n,[a]:s});const r={...o};r[a]&&(delete r[a],Z(r))},ae=async t=>{var a;t.preventDefault();try{const s={...n};if(s.fullName=`${n.title} ${n.firstName} ${n.lastName}`.trim(),s.dateOfBirth){const r=new Date(s.dateOfBirth);if(!isNaN(r)){const m=String(r.getDate()).padStart(2,"0"),u=String(r.getMonth()+1).padStart(2,"0"),N=r.getFullYear();s.dateOfBirth=`${m}-${u}-${N}`}}if(k){const r=await he(s.mobileNumber,s);console.log("Update response:",r),f.success("Customer updated successfully")}else{const r=await ue(s);console.log("Add response:",r),f.success("Customer added successfully")}await E(),U()}catch(s){console.error("Error submitting customer:",s),((a=s==null?void 0:s.response)==null?void 0:a.status)===409?f.error("Customer already exists with this mobile number or email."):f.error("Something went wrong while submitting.")}},U=()=>{F(!1),V(!1),Y(null),g({fullName:"",mobileNumber:"",gender:"",emailId:"",dateOfBirth:"",referCode:""})},P=K.useMemo(()=>{const t=$.toLowerCase().trim();return t?S.filter(a=>Object.values(a).some(s=>String(s).toLowerCase().includes(t))):S},[$,S]),Q=P.slice((p-1)*w,p*w);l.useEffect(()=>{if(n.dateOfBirth){const t=new Date(n.dateOfBirth);if(isNaN(t))O("");else{const a=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),r=t.getFullYear();O(`${a}-${s}-${r}`)}}else O("")},[n.dateOfBirth]);const re=async()=>{try{await ce(z),f.success("Customer deleted successfully");const t=S.filter(a=>(a==null?void 0:a.mobileNumber)!==z);B(t)}catch(t){console.error("Delete failed:",t),f.error("Failed to delete customer")}finally{I(!1),T(null)}};return e.jsx(e.Fragment,{children:J?e.jsxs(e.Fragment,{children:[e.jsx("h4",{className:"mb-4",children:k?"Edit Customer":"Add New Customer"}),e.jsxs(ye,{onSubmit:ae,children:[e.jsxs(y,{className:"mb-3",children:[e.jsxs(i,{md:2,children:[e.jsxs(d,{children:["Title ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs(q,{name:"title",value:n.title,onChange:x,invalid:!!o.title,children:[e.jsx("option",{value:"",children:"Select Title"}),e.jsx("option",{value:"Mr.",children:"Mr."}),e.jsx("option",{value:"Mrs.",children:"Mrs."}),e.jsx("option",{value:"Miss",children:"Miss."}),e.jsx("option",{value:"Ms.",children:"Ms."}),e.jsx("option",{value:"Mx.",children:"Mx."}),e.jsx("option",{value:"Dr.",children:"Dr."}),e.jsx("option",{value:"Prof.",children:"Prof."}),e.jsx("option",{value:"Rev.",children:"Rev."}),e.jsx("option",{value:"Sir",children:"Sir."}),e.jsx("option",{value:"Dame",children:"Dame."}),e.jsx("option",{value:"Lord",children:"Lord"}),e.jsx("option",{value:"Lady",children:"Lady"}),e.jsx("option",{value:"Capt.",children:"Capt."}),e.jsx("option",{value:"Col.",children:"Col."}),e.jsx("option",{value:"Gen.",children:"Gen."}),e.jsx("option",{value:"Hon.",children:"Hon."})]}),o.title&&e.jsx("div",{className:"text-danger small",children:o.title})]}),e.jsxs(i,{md:4,children:[e.jsxs(d,{children:["First Name ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(c,{name:"firstName",value:n.firstName,onChange:x,invalid:!!o.firstName}),o.firstName&&e.jsx("div",{className:"text-danger small",children:o.firstName})]}),e.jsxs(i,{md:3,children:[e.jsx(d,{children:"Last Name"}),e.jsx(c,{name:"lastName",value:n.lastName,onChange:x})]}),e.jsxs(i,{md:3,children:[e.jsxs(d,{children:["Date of Birth ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(c,{type:"date",name:"dateOfBirth",value:n.dateOfBirth,onChange:t=>{x(t);const a=new Date(t.target.value);if(isNaN(a))g(s=>({...s,age:""}));else{const s=Date.now()-a.getTime(),r=new Date(s),m=Math.abs(r.getUTCFullYear()-1970);g(u=>({...u,age:m.toString()}))}},max:new Date().toISOString().split("T")[0],invalid:!!o.dateOfBirth}),o.dateOfBirth&&e.jsx("div",{className:"text-danger small",children:o.dateOfBirth})]})]}),e.jsxs(y,{className:"mb-3",children:[e.jsxs(i,{md:2,children:[e.jsx(d,{children:"Age"}),e.jsx(c,{name:"age",value:n.age||"",readOnly:!0})]}),e.jsxs(i,{md:4,children:[e.jsxs(d,{children:["Mobile Number",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(c,{name:"mobileNumber",value:n.mobileNumber,onChange:x,onKeyDown:t=>{!/[0-9]/.test(t.key)&&t.key!=="Backspace"&&t.key!=="Delete"&&t.preventDefault()},onPaste:t=>t.preventDefault(),maxLength:10,invalid:!!o.mobileNumber,disabled:k}),o.mobileNumber&&e.jsx("div",{className:"text-danger small",children:o.mobileNumber})]}),e.jsxs(i,{md:3,children:[e.jsxs(d,{children:["Gender ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs(q,{name:"gender",value:n.gender,onChange:x,invalid:!!o.gender,children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"Male",children:"Male"}),e.jsx("option",{value:"Female",children:"Female"})]}),o.gender&&e.jsx("div",{className:"text-danger small",children:o.gender})]}),e.jsxs(i,{md:3,children:[e.jsx(d,{children:"Referral Code"}),e.jsx(c,{name:"referCode",value:n.referCode,onChange:x}),o.referCode&&e.jsx("div",{className:"text-danger",children:o.referCode})]})]}),e.jsxs(y,{className:"mt-3",children:[e.jsxs(i,{md:2,children:[e.jsxs(d,{children:["House No ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(c,{type:"text",value:n.address.houseNo,onChange:t=>h("address","houseNo",t.target.value)})]}),e.jsxs(i,{md:4,children:[e.jsxs(d,{children:["Postal Code ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(c,{type:"text",maxLength:6,value:n.address.postalCode,onChange:t=>ee(t.target.value),placeholder:"6-digit PIN"})]}),e.jsxs(i,{md:3,children:[e.jsxs(d,{children:["Street ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(c,{type:"text",value:b(n.address.street),onChange:t=>h("address","street",t.target.value)})]}),e.jsxs(i,{md:3,children:[e.jsx(d,{children:"Landmark"}),e.jsx(c,{type:"text",value:b(n.address.landmark),onChange:t=>h("address","landmark",t.target.value)})]})]}),e.jsxs(y,{children:[e.jsxs(i,{md:2,children:[e.jsxs(d,{children:["City ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(c,{type:"text",value:b(n.address.city),onChange:t=>h("address","city",t.target.value)})]}),e.jsxs(i,{md:4,children:[e.jsxs(d,{children:["State ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(c,{type:"text",value:b(n.address.state),onChange:t=>h("address","state",t.target.value)})]}),e.jsxs(i,{md:3,children:[e.jsxs(d,{children:["Country ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(c,{type:"text",value:b(n.address.country),onChange:t=>h("address","country",t.target.value)})]})]}),e.jsxs("div",{className:"d-flex justify-content-end",children:[e.jsx(M,{color:"secondary",className:"me-2",onClick:U,children:"Cancel"}),e.jsx(M,{type:"submit",color:"success",style:{backgroundColor:"var(--color-black)",color:"white",border:"none"},children:k?"Update":"Submit"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(y,{className:"d-flex align-items-center mb-3",children:[e.jsx(ie,{}),e.jsx("div",{className:"mb-3 w-100",style:{display:"flex",justifyContent:"end",alignContent:"end",alignItems:"end"},children:e.jsx(M,{style:{color:"var(--color-black)",backgroundColor:"var(--color-bgcolor)"},onClick:()=>F(!0),children:"Add New Customer"})})]}),e.jsx(fe,{isVisible:X,title:"Delete Customer",message:"Are you sure you want to delete this Customer? This action cannot be undone.",confirmText:"Yes, Delete",cancelText:"Cancel",confirmColor:"danger",cancelColor:"secondary",onConfirm:re,onCancel:()=>{I(!1),T(null)}}),R?e.jsx("div",{className:"d-flex justify-content-center align-items-center",children:e.jsx(xe,{message:"Loading customers..."})}):H?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"50vh",color:"var(--color-black)"},children:H}):P.length===0?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"50vh",color:"var(--color-black)"},children:"No Customer Data Found"}):e.jsxs(e.Fragment,{children:[e.jsxs(ge,{hover:!0,striped:!0,responsive:!0,children:[e.jsx(je,{className:"pink-table  w-auto",children:e.jsxs(A,{children:[e.jsx(v,{children:"S.No"}),e.jsx(v,{children:"Full Name"}),e.jsx(v,{children:"Mobile Number"}),e.jsx(v,{children:"Gender"}),e.jsx(v,{className:"text-end",children:"Actions"})]})}),e.jsx(pe,{className:"pink-table",children:Q.length>0?Q.map((t,a)=>e.jsxs(A,{children:[e.jsxs(j,{children:[" ",(p-1)*w+a+1]}),e.jsx(j,{children:(t==null?void 0:t.fullName)||"-"}),e.jsx(j,{children:(t==null?void 0:t.mobileNumber)||"-"}),e.jsx(j,{children:(t==null?void 0:t.gender)||"-"}),e.jsx(j,{className:"text-end",children:e.jsxs("div",{className:"d-flex justify-content-end gap-2  ",children:[e.jsx("button",{className:"actionBtn",onClick:()=>te(t==null?void 0:t.mobileNumber),title:"View",children:e.jsx(Ce,{size:18})}),e.jsx("button",{className:"actionBtn",onClick:()=>se(t==null?void 0:t.mobileNumber),title:"Edit",children:e.jsx(be,{size:18})}),e.jsx("button",{className:"actionBtn",onClick:()=>{T(t==null?void 0:t.mobileNumber),I(!0)},title:"Delete",children:e.jsx(Ne,{size:18})})]})})]},t.mobileNumber||a)):e.jsx(A,{children:e.jsxs(j,{colSpan:5,className:"text-center text-muted",children:['🔍 No diseases found matching "',e.jsx("b",{children:$}),'"']})})})]}),!R&&e.jsx("div",{className:"d-flex justify-content-end mt-3",style:{marginRight:"40px"},children:Array.from({length:Math.ceil(P.length/w)},(t,a)=>e.jsx(M,{style:{backgroundColor:p===a+1?"var(--color-black)":"#fff",color:p===a+1?"#fff":"var(--color-black)",border:"1px solid #ccc",borderRadius:"5px",cursor:"pointer"},className:"ms-2",onClick:()=>_(a+1),children:a+1},a))})]})]})})},_e=K.memo(ve);export{_e as default};
